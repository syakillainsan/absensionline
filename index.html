<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Sekolah (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .login-wallpaper {
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1481627834876-b7833e8f5570?q=80&w=2128&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .card { @apply bg-white p-6 rounded-xl shadow-md border border-slate-100; }
        .btn { @apply font-bold py-2.5 px-6 rounded-lg shadow-sm transition-all duration-200 ease-in-out hover:shadow-md active:scale-95 focus:outline-none focus:ring-2 focus:ring-offset-2; }
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500; }
        .btn-green { @apply bg-emerald-600 hover:bg-emerald-700 text-white focus:ring-emerald-500; }
        .btn-red { @apply bg-rose-600 hover:bg-rose-700 text-white focus:ring-rose-500; }
        .input-field { @apply w-full px-4 py-2 mt-1 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800">

    <div id="app-container" class="w-full">
        <!-- HEADER -->
        <header id="app-header" class="bg-white shadow-sm sticky top-0 z-40 border-b border-slate-200">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                    </div>
                    <h1 class="text-xl font-bold text-slate-800 hidden md:block">Sistem Absensi Sekolah</h1>
                </div>
                <div id="user-info" class="text-sm"></div>
            </nav>
        </header>

        <!-- MAIN CONTENT -->
        <main class="container mx-auto px-4 md:px-6 py-8 flex-grow">
            <div id="notification" class="fixed top-20 right-4 z-50 hidden transition-all duration-300"></div>
            <div id="app-content" class="h-full">
                <!-- Content will be rendered by JavaScript -->
            </div>
        </main>
    </div>

    <!-- MODAL (HIDDEN INITIALLY) -->
    <div id="edit-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex justify-center items-center z-50 hidden transition-opacity">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Edit Absensi</h2>
            <form id="edit-form">
                <input type="hidden" name="id" />
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-600">Nama Siswa</label>
                    <input type="text" name="nama" class="input-field" required />
                </div>
                 <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-600">Kelas</label>
                    <input type="text" name="kelas" class="input-field" required />
                </div>
                 <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-600">Status Kehadiran</label>
                    <select name="status" class="input-field">
                        <option value="Hadir">Hadir</option>
                        <option value="Izin">Izin</option>
                        <option value="Sakit">Sakit</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-edit-btn" class="px-4 py-2 rounded-lg font-medium text-slate-600 hover:bg-slate-100 transition-colors">Batal</button>
                    <button type="submit" class="btn btn-primary py-2">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- KONFIGURASI SUPABASE (WAJIB DIISI) ---
    const SUPABASE_URL = 'https://eszxwkbijbgmghvwhtsh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzenh3a2JpamJnbWdodndodHNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMDA5MDcsImV4cCI6MjA3NTg3NjkwN30.ETtXRg_N2ANy17GLQG8Q3t7vlHk4Z5jsXNAGC4ILqwY';
    
    if (SUPABASE_URL.includes('URL_PROYEK') || SUPABASE_ANON_KEY.includes('KUNCI_ANON')) {
        document.getElementById('app-content').innerHTML = `
            <div class="max-w-2xl mx-auto bg-amber-50 border-l-4 border-amber-400 p-4 rounded-md text-amber-700">
                <div class="flex">
                    <div class="flex-shrink-0"><svg class="h-5 w-5 text-amber-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></div>
                    <div class="ml-3">
                        <h3 class="text-lg font-medium">Konfigurasi Diperlukan</h3>
                        <div class="mt-2 text-sm"><p>Silakan buka file ini di text editor dan isi <strong>SUPABASE_URL</strong> serta <strong>SUPABASE_ANON_KEY</strong> dengan kredensial dari proyek Supabase Anda.</p></div>
                    </div>
                </div>
            </div>`;
        return;
    }

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- VARIABLES ---
    let currentUser = null;
    let currentPage = 'login';

    // --- ELEMENTS ---
    const body = document.body;
    const userInfo = document.getElementById('user-info');
    const appContent = document.getElementById('app-content');
    const notifElement = document.getElementById('notification');
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');

    // --- TEMPLATES HTML ---
    const loginTemplate = `
        <div class="min-h-[80vh] flex flex-col justify-center py-12 sm:px-6 lg:px-8">
            <div class="sm:mx-auto sm:w-full sm:max-w-md">
                <div class="bg-white py-8 px-4 shadow-xl rounded-2xl sm:px-10 border border-slate-100">
                    <div class="sm:mx-auto sm:w-full sm:max-w-[200px] mb-6">
                       <div class="flex justify-center text-blue-600 mb-4">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                       </div>
                       <h2 class="text-center text-3xl font-extrabold text-slate-900">Login Akun</h2>
                    </div>
                    <form id="login-form" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Username</label>
                            <div class="mt-1"><input type="text" name="username" required class="input-field" placeholder="Masukkan username Anda" /></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Password</label>
                            <div class="mt-1"><input type="password" name="password" required class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
                        </div>
                        <div>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all">
                                Masuk Sekarang
                            </button>
                        </div>
                    </form>
                    <div class="mt-6">
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                            <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-slate-500">Atau</span></div>
                        </div>
                        <div class="mt-6 text-center">
                            <p class="text-slate-600">Belum memiliki akun? <button id="switch-to-register" class="font-medium text-blue-600 hover:text-blue-500 transition-colors">Daftar di sini</button></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;

    const registerTemplate = `
        <div class="min-h-[80vh] flex flex-col justify-center py-12 sm:px-6 lg:px-8">
            <div class="sm:mx-auto sm:w-full sm:max-w-md">
                <div class="bg-white py-8 px-4 shadow-xl rounded-2xl sm:px-10 border border-slate-100">
                    <h2 class="mb-6 text-center text-3xl font-extrabold text-slate-900">Buat Akun Baru</h2>
                    <form id="register-form" class="space-y-5">
                        <div><label class="block text-sm font-medium text-slate-700">Nama Lengkap</label><input type="text" name="nama_lengkap" required class="input-field" placeholder="Contoh: Budi Santoso" /></div>
                        <div><label class="block text-sm font-medium text-slate-700">Username (Unik)</label><input type="text" name="username" required pattern="^[a-zA-Z0-9_]{3,}$" title="Minimal 3 karakter, huruf, angka, atau '_'" class="input-field" placeholder="Contoh: budi_s" /></div>
                        <div><label class="block text-sm font-medium text-slate-700">Email</label><input type="email" name="email" required class="input-field" placeholder="budi@example.com" /></div>
                        <div><label class="block text-sm font-medium text-slate-700">Password</label><input type="password" name="password" required minlength="8" class="input-field" placeholder="Minimal 8 karakter" /></div>
                        <div><label class="block text-sm font-medium text-slate-700">Kelas (Siswa)</label><input type="text" name="kelas" required class="input-field" placeholder="Contoh: XII-IPA 1" /></div>
                        <button type="submit" class="w-full btn btn-primary py-3 mt-4">Daftar Sekarang</button>
                    </form>
                    <p class="mt-6 text-center text-slate-600">Sudah punya akun? <button id="switch-to-login" class="font-medium text-blue-600 hover:text-blue-500 transition-colors">Login di sini</button></p>
                </div>
            </div>
        </div>`;

    // --- HELPER FUNCTIONS ---
    const showNotif = (message, type = 'success') => {
        notifElement.className = `fixed top-6 right-6 z-50 p-4 rounded-xl shadow-lg text-white font-semibold transform transition-all duration-500 ease-out translate-y-0 opacity-100 flex items-center gap-3 ${type === 'success' ? 'bg-emerald-500' : 'bg-rose-500'}`;
        notifElement.innerHTML = `${type === 'success' ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'} <span>${message}</span>`;
        notifElement.classList.remove('hidden', 'translate-y-[-100%]', 'opacity-0');
        setTimeout(() => notifElement.classList.add('translate-y-[-100%]', 'opacity-0'), 3000);
        setTimeout(() => notifElement.classList.add('hidden'), 3500);
    };

    // --- MAIN RENDER FUNCTION ---
    const render = async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();

        if (session) {
            if (!currentUser) {
                const { data: profile, error } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
                if (profile) {
                    currentUser = { ...session.user, profile };
                } else {
                    await supabaseClient.auth.signOut(); return;
                }
            }
            body.className = "bg-slate-50 min-h-screen font-sans text-slate-800";
            userInfo.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="font-bold text-slate-800">${currentUser.profile.nama_lengkap}</p>
                        <p class="text-xs text-slate-500 uppercase tracking-wider">${currentUser.profile.role}</p>
                    </div>
                    <button id="logout-btn" class="btn btn-red text-sm py-2 px-4">Logout</button>
                </div>`;
            document.getElementById('logout-btn').addEventListener('click', async () => { await supabaseClient.auth.signOut(); render(); });
            currentUser.profile.role === 'admin' ? renderAdminDashboard() : renderSiswaDashboard();
        } else {
            currentUser = null;
            body.className = "login-wallpaper min-h-screen font-sans flex items-center justify-center p-4";
            userInfo.innerHTML = '';
            appContent.innerHTML = currentPage === 'login' ? loginTemplate : registerTemplate;
            if (currentPage === 'login') {
                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.getElementById('switch-to-register').addEventListener('click', () => { currentPage = 'register'; render(); });
            } else {
                document.getElementById('register-form').addEventListener('submit', handleRegister);
                document.getElementById('switch-to-login').addEventListener('click', () => { currentPage = 'login'; render(); });
            }
        }
    };

    // --- DASHBOARD RENDERERS ---
    const renderSiswaDashboard = async () => {
        const todayStr = new Date().toISOString().slice(0, 10);
        const { data: absensiHariIni } = await supabaseClient.from('absensi').select('status').eq('user_id', currentUser.id).eq('tanggal', todayStr).maybeSingle();

        appContent.innerHTML = `
            <div class="max-w-4xl mx-auto space-y-8">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800 mb-2">Selamat Datang, ${currentUser.profile.nama_lengkap.split(' ')[0]}! üëã</h2>
                        <p class="text-slate-500">Jangan lupa isi absensi hari ini ya.</p>
                    </div>
                    <div class="bg-blue-50 px-6 py-3 rounded-xl border border-blue-100">
                        <p class="text-sm text-blue-600 font-medium">Kelas Anda</p>
                        <p class="text-2xl font-bold text-blue-800">${currentUser.profile.kelas}</p>
                    </div>
                </div>

                <div class="card text-center py-10">
                    <h3 class="text-xl font-bold mb-6 text-slate-800">Status Kehadiran Hari Ini</h3>
                    ${absensiHariIni ? 
                        `<div class="inline-flex items-center gap-2 px-6 py-3 rounded-full bg-emerald-100 text-emerald-800 font-bold text-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                            Anda tercatat '${absensiHariIni.status}'
                        </div>` : 
                        `<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 max-w-2xl mx-auto">
                            ${['Hadir', 'Izin', 'Sakit'].map(status => `
                                <button data-status="${status}" class="absen-btn group p-6 rounded-xl border-2 transition-all duration-200 flex flex-col items-center gap-3
                                    ${status === 'Hadir' ? 'bg-emerald-50 border-emerald-200 hover:border-emerald-500 text-emerald-700' : 
                                      status === 'Izin' ? 'bg-amber-50 border-amber-200 hover:border-amber-500 text-amber-700' : 
                                      'bg-rose-50 border-rose-200 hover:border-rose-500 text-rose-700'}">
                                    <span class="text-3xl">${status === 'Hadir' ? 'üëã' : status === 'Izin' ? 'üìù' : 'ü§í'}</span>
                                    <span class="font-bold text-lg">${status}</span>
                                </button>
                            `).join('')}
                        </div>
                        <div class="mt-8 pt-6 border-t border-slate-100 max-w-md mx-auto">
                            <label class="block text-sm font-medium text-slate-600 mb-2">Unggah Foto Bukti (Opsional)</label>
                            <input id="foto-input" type="file" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer bg-slate-50 rounded-full border border-slate-200"/>
                        </div>`
                    }
                </div>
            </div>`;
        if (!absensiHariIni) document.querySelectorAll('.absen-btn').forEach(btn => btn.addEventListener('click', handleAbsensi));
    };

    const renderAdminDashboard = async () => {
        const { data: absensi } = await supabaseClient.from('absensi').select('*').order('created_at', { ascending: false });
        appContent.innerHTML = `
            <div class="max-w-6xl mx-auto space-y-8">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-slate-800">Dashboard Admin</h2>
                    <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg font-medium">Total Data: ${absensi?.length || 0}</div>
                </div>
                <div class="card overflow-hidden p-0">
                    <div class="overflow-x-auto">
                       <table class="min-w-full divide-y divide-slate-200">
                           <thead class="bg-slate-50">
                               <tr>
                                   ${['Waktu', 'Tanggal', 'Nama Siswa', 'Kelas', 'Status', 'Bukti', 'Aksi'].map(h => 
                                       `<th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">${h}</th>`
                                   ).join('')}
                               </tr>
                           </thead>
                           <tbody class="bg-white divide-y divide-slate-100">
                               ${absensi?.length ? absensi.map(item => `
                                   <tr class="hover:bg-slate-50 transition-colors">
                                       <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item.jam?.slice(0,5) || '-'}</td>
                                       <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>
                                       <td class="px-6 py-4 whitespace-nowrap font-medium text-slate-900">${item.nama}</td>
                                       <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600"><span class="px-2 py-1 bg-slate-100 rounded-md">${item.kelas}</span></td>
                                       <td class="px-6 py-4 whitespace-nowrap"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                                        ${item.status === 'Hadir' ? 'bg-emerald-100 text-emerald-800' : item.status === 'Izin' ? 'bg-amber-100 text-amber-800' : 'bg-rose-100 text-rose-800'}">
                                        ${item.status}</span></td>
                                       <td class="px-6 py-4 whitespace-nowrap text-sm">${item.foto_url ? `<a href="${item.foto_url}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> Lihat</a>` : '<span class="text-slate-400">-</span>'}</td>
                                       <td class="px-6 py-4 whitespace-nowrap text-sm"><button data-id="${item.id}" class="edit-btn text-amber-600 hover:text-amber-900 font-medium">Edit</button></td>
                                   </tr>`).join('') : '<tr><td colspan="7" class="px-6 py-12 text-center text-slate-500 italic">Belum ada data absensi yang masuk.</td></tr>'}
                           </tbody>
                       </table>
                   </div>
                </div>
            </div>`;
        appContent.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleOpenModal));
    };

    // --- ACTION HANDLERS ---
    const handleLogin = async (e) => {
        e.preventDefault();
        const { username, password } = Object.fromEntries(new FormData(e.target));
        // 1. Cari email dari username
        const { data, error } = await supabaseClient.from('profiles').select('email').eq('username', username).single();
        if (error || !data) return showNotif('Username tidak ditemukan.', 'error');
        // 2. Login dengan email yang ditemukan
        const { error: signInError } = await supabaseClient.auth.signInWithPassword({ email: data.email, password });
        if (signInError) return showNotif('Password salah.', 'error');
        showNotif('Login berhasil! Mengalihkan...', 'success');
        render();
    };

    const handleRegister = async (e) => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(e.target));
        if (formData.password.length < 8) return showNotif('Password minimal 8 karakter.', 'error');

        // Cek username unik
        const { data: existing } = await supabaseClient.from('profiles').select('username').eq('username', formData.username).maybeSingle();
        if (existing) return showNotif('Username sudah dipakai.', 'error');

        const role = formData.username.toLowerCase().includes('admin') ? 'admin' : 'siswa';
        const { data: authData, error: signUpError } = await supabaseClient.auth.signUp({ email: formData.email, password: formData.password });
        if (signUpError) return showNotif(signUpError.message, 'error');

        if (authData.user) {
            const { error: profileError } = await supabaseClient.from('profiles').insert({
                id: authData.user.id,
                username: formData.username,
                email: formData.email,
                nama_lengkap: formData.nama_lengkap,
                kelas: role === 'siswa' ? formData.kelas : null,
                role: role
            });
            if (profileError) return showNotif(profileError.message, 'error');
        }
        showNotif('Registrasi berhasil! Silakan login.', 'success');
        currentPage = 'login';
        render();
    };

    const handleAbsensi = async (e) => {
        const status = e.currentTarget.dataset.status;
        const fotoFile = document.getElementById('foto-input').files[0];
        let foto_url = null;

        if (fotoFile) {
            const fileName = `${currentUser.id}/${Date.now()}.jpg`;
            const { error: uploadError } = await supabaseClient.storage.from('bukti_absensi').upload(fileName, fotoFile);
            if (uploadError) return showNotif('Gagal upload foto: ' + uploadError.message, 'error');
            const { data } = supabaseClient.storage.from('bukti_absensi').getPublicUrl(fileName);
            foto_url = data.publicUrl;
        }

        const { error } = await supabaseClient.from('absensi').insert({
            user_id: currentUser.id,
            nama: currentUser.profile.nama_lengkap,
            kelas: currentUser.profile.kelas,
            tanggal: new Date().toISOString().slice(0, 10),
            jam: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
            status, foto_url
        });

        if (error) return showNotif(error.message, 'error');
        showNotif(`Absensi '${status}' berhasil!`, 'success');
        render();
    };

    const handleOpenModal = async (e) => {
        const { data } = await supabaseClient.from('absensi').select('*').eq('id', e.target.dataset.id).single();
        if (data) {
            ['id', 'nama', 'kelas', 'status'].forEach(field => editForm[field].value = data[field]);
            editModal.classList.remove('hidden');
        }
    };

    document.getElementById('cancel-edit-btn').onclick = () => editModal.classList.add('hidden');
    editForm.onsubmit = async (e) => {
        e.preventDefault();
        const { id, nama, kelas, status } = Object.fromEntries(new FormData(e.target));
        const { error } = await supabaseClient.from('absensi').update({ nama, kelas, status }).eq('id', id);
        if (!error) { showNotif('Data diperbarui.', 'success'); editModal.classList.add('hidden'); render(); }
    };

    render(); // Initial Render
});
</script>
</body>
</html>
